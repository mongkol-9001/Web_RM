<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rm</title>
  <link class="jsbin" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/base/jquery-ui.css" rel="stylesheet"
    type="text/css" />
  <script class="jsbin" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
  <script class="jsbin" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.0/jquery-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCvReady();"
    type="text/javascript"></script>

  <!--[if IE]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
  <link rel="stylesheet" type="text/css" href="style.css" />
</head>

<body>
  <div class="topnav">

    <section class="showcase">
      <video src="./work1/galaxy-67384.mp4" autoplay loop muted></video>
      <h1 class="title">Pix2Code</h1>

    </section>

  </div>

  <div class="container">
    <div class="card">
      <div class="card-body text-center">
        <div class="row">
          <div class="col" style="background-color:#aaa;">
            <h2>What is a Pix2code</h2>
            <p>wdjdfkglgfd;</p>
            <div class="example">
              <div class="example-image">

              </div>
            </div>

          </div>
          <div class="col-8" style="background-color:#bbb;">
            <h2>Example</h2>
            <div class="col"><img id="example-image" src="./work1/0.png" /></div>
            <div class="col"><img id="example-image" src="./work1/0.png" /></div>

          </div>
        </div>
        <div class="row">
          <div class="column">
            <div class="drop-zone">
              <span class="drop-zone__prompt">Drop file here or click to upload</span>
              <form action="{{ url_for('predicts') }}" method="post" enctype="multipart/form-data">
                <input type="file" name="myFile" required>
                <button type="submit">Upload</button>
            </form>
            </div>

          </div>
          <div class="column">
            
          </div>
        </div>
        <div class="row">
          <div class="column" style="background-color:#aaa;">
            <h2>Example</h2>
            <div class="example">
              <div class="example-image">
                <img id="example-image" src="./work1/0.png" />
              </div>
            </div>

          </div>
          <div class="column" style="background-color:#bbb;">
            <h2>Code</h2>
            <p>{{prediction_text}}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.querySelectorAll(".drop-zone__input").forEach((inputElement) => {
      const dropZoneElement = inputElement.closest(".drop-zone");

      dropZoneElement.addEventListener("click", (e) => {
        inputElement.click();
      });

      inputElement.addEventListener("change", (e) => {
        if (inputElement.files.length) {
          updateThumbnail(dropZoneElement, inputElement.files[0]);
        }
      });

      dropZoneElement.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZoneElement.classList.add("drop-zone--over");
      });

      ["dragleave", "dragend"].forEach((type) => {
        dropZoneElement.addEventListener(type, (e) => {
          dropZoneElement.classList.remove("drop-zone--over");
        });
      });

      dropZoneElement.addEventListener("drop", (e) => {
        e.preventDefault();

        if (e.dataTransfer.files.length) {
          inputElement.files = e.dataTransfer.files;
          updateThumbnail(dropZoneElement, e.dataTransfer.files[0]);
        }

        dropZoneElement.classList.remove("drop-zone--over");
      });
    });

    /**
     * Updates the thumbnail on a drop zone element.
     *
     * @param {HTMLElement} dropZoneElement
     * @param {File} file
     */
    function updateThumbnail(dropZoneElement, file) {
      let thumbnailElement = dropZoneElement.querySelector(".drop-zone__thumb");

      // First time - remove the prompt
      if (dropZoneElement.querySelector(".drop-zone__prompt")) {
        dropZoneElement.querySelector(".drop-zone__prompt").remove();
      }

      // First time - there is no thumbnail element, so lets create it
      if (!thumbnailElement) {
        thumbnailElement = document.createElement("div");
        thumbnailElement.classList.add("drop-zone__thumb");
        dropZoneElement.appendChild(thumbnailElement);
      }

      thumbnailElement.dataset.label = file.name;

      // Show thumbnail for image files
      if (file.type.startsWith("image/")) {
        const reader = new FileReader();

        reader.readAsDataURL(file);
        reader.onload = () => {
          thumbnailElement.style.backgroundImage = `url('${reader.result}')`;
        };
      } else {
        thumbnailElement.style.backgroundImage = null;
      }
    }



  </script>


  <script>
    async function resizeImg(image) {


      let canvas = document.createElement('canvas');
      canvas.width = 200;
      canvas.height = 200;
      // Draw the image onto the canvas
      let ctx = canvas.getContext('2d');
      ctx.drawImage(image, 0, 0, 200, 200);
      // Get the pixel data from the canvas
      let imageData = ctx.getImageData(0, 0, 200, 200);
      let data = imageData.data;

      return imageData;
    }
    function imageDataTo3DArray(imageData) {
      let width = imageData.width;
      let height = imageData.height;
      let data = imageData.data;
      let result = new Array(height);
      for (let i = 0; i < height; i++) {
        result[i] = new Array(width);
        for (let j = 0; j < width; j++) {
          let index = (i * width + j) * 4;
          result[i][j] = [data[index], data[index + 1], data[index + 2]];
        }
      }
      return result;
    }

    function imageDataTo3DArray_1(imageData) {
      let width = imageData.width;
      let height = imageData.height;
      let data = imageData.data;
      let result = new Float32Array(height * width * 3);
      for (let i = 0; i < height; i++) {
        for (let j = 0; j < width; j++) {
          let index = (i * width + j) * 4;
          let resultIndex = (i * width + j) * 3;
          result[resultIndex] = data[index] * 255;
          result[resultIndex + 1] = data[index + 1] * 255;
          result[resultIndex + 2] = data[index + 2] * 255;
        }
      }
      return result;
    }
    class Node {
      constructor(key, parent_node, content_holder) {
        this.key = key;
        this.parent = parent_node;
        this.children = [];
        this.content_holder = content_holder;
      }

      addChildNode(child) {
        this.children.push(child);
      }

      show() {
        console.log(this.key);
        for (let child of this.children) {
          child.show();
        }
      }

      render(mapping, rendering_function = null) {
        let content = "";
        for (let child of this.children) {
          content += child.render(mapping, rendering_function);
        }
        let value = mapping[this.key];
        if (rendering_function !== null) {
          value = rendering_function(this.key, value);
        }
        if (this.children.length !== 0) {
          value = value.replace(this.content_holder, content);
        }
        return value;
      }

      getParent() {
        return this.parent;
      }
    }

    function add_child(node, currentNode) {
      currentNode.addChildNode(node);
      return currentNode;
    }
    function compilee(dsl) {
      let masterNode = new Node("body", null, "{}");
      let currentNode = new Node("body", null, "{}");
      let numOpenTags = 0;

      for (let tk of dsl) {
        if (tk === ",") {
          continue;
        }
        if (tk === "{") {
          masterNode = currentNode;
        } else if (tk === "}") {
          masterNode = masterNode.getParent();
        } else {
          let element = new Node(tk, masterNode, "{}");
          currentNode = element;
          masterNode.addChildNode(element);
        }
      }

      return masterNode.render(DEFAULT_DSL_MAPPING_FILEPATH, null);
    }
    const indexToWord = (index, vocabulary) => {
      const reversedVocabulary = Object.keys(vocabulary).reduce((acc, key) => {
        acc[vocabulary[key]] = key;
        return acc;
      }, {});

      return reversedVocabulary[index] || "";
    };
    const textToSequences = (text, vocabulary) => {
      const words = text.split(" ");
      return words.map(word => vocabulary[word] || 0);
    }
    async function predictCaption(image, vocabulary, max_length) {
      let in_text = '<start>';
      const model = await tf.loadLayersModel('model/model.json');

      for (let i = 0; i < max_length; i++) {
        const sequences = textToSequences(in_text, vocabulary);
        const paddedSequences = new Array(max_length).fill(0);
        paddedSequences.splice(0, sequences.length, ...sequences);
        const input = tf.tensor(paddedSequences);
        const input2 = input.expandDims(0);
        const yhat = model.predict([image, input2]);
        let tensor = yhat.dataSync();
        let max = Math.max(...tensor);
        let index = tensor.indexOf(max);
        const word = indexToWord(index, vocabulary);

        tf.dispose(input);
        tf.dispose(input2);

        if (i == 5) {
          break;
        }
        if (word === null) {
          break;
        }
        in_text += " " + word;
        if (word === '<end>') {
          break;
        }
      }
      console.log(in_text);
      return in_text;
    }





    var input = document.getElementById('inputImage');
    var file = input.files[0];
    const btn = document.getElementById('generate');
    let arr;
    btn.addEventListener('click', async function () {
      const file = input.files[0];
      const reader = new FileReader();

      reader.readAsDataURL(file);
      reader.onload = function () {
        let img = new Image();
        img.src = reader.result;
        img.onload = async function () {

          <!-- const tfImg = tf.browser.fromPixels(img);
          const resized = tf.image.resizeBilinear(tfImg, [200, 200]);
          const normalized = resized.div(tf.scalar(255.0));
          const imgtensorB = normalized.expandDims(0); -->
          // Create a canvas element to draw the image on
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, img.width, img.height);

          // Get the image data from the canvas
          const imageData = ctx.getImageData(0, 0, img.width, img.height);
          // Create an OpenCV matrix from the image data
          const src = cv.matFromImageData(imageData);

          // Resize the image to 200x200 using the `cvstfjs` library
          const resized = new cv.Mat();
          cv.resize(src, resized, new cv.Size(200, 200), 0, 0, cv.INTER_AREA);

          // Normalize the pixel values to the range [0, 1]
          const normalized = new cv.Mat();
          resized.convertTo(normalized, cv.CV_32F, 1 / 255.0);
         


          let vocabulary =
          {
            '{': 1,
            '}': 2,
            'small-title': 3,
            'text': 4,
            'btn-orange': 5,
            'quadruple': 6,
            'btn-inactive': 7,
            'row': 8,
            'double': 9,
            '<start>': 10,
            'header': 11,
            '<end>': 12,
            'single': 13
          };


          const ouput = predictCaption(imgtensorB, vocabulary, 90);
          console.log("---------------------------");
          console.log(ouput);

        };

      };




    });

    window.addEventListener('beforeunload', function (event) {
      event.preventDefault();
      event.returnValue = '';
    });
  </script>

</body>

</html>